%-*-coding: utf-8-*-

\chapter{Анализ предложенного алгоритма}  \label{chapter3}

\section{Модель и определения}
Злые участники \textbf{TODO}.

\textit{Определение.} Будем называть изменение $d$ \textit{оседлым} в слоте $s$, если как минимум $f+1$ честный участник имеет корректный сертификат согласия для пары $(s, d)$.

\textit{Определение.} Будем считать, что честный участник находится в \textit{забвении},  если он ожидает нового лидера. \textbf{TODO}

\textit{Определение.} Состояние системы называется \textit{устойчивым состоянием}, если не более $f$ честных участников находится в забвении.

\section{Базовые свойства}
Если система не находится в устойчивом состоянии, будем говорить, что она находится в \textit{неустойчивом} состоянии.

\section{Консистентность алгоритма}
В данном разделе будет дано определение \textit{консистентности} (Consistency)\cite{hybrid-consensus} и доказано, что предложенный алгоритм обладает этим свойством.

Будем считать, что алгоритм обладает свойством \textit{общего префикса}, если в любой момент для любых двух честных участников комитета (возможно одного и того же) $i$ и $j$  выполняется: либо $Log_{C_i}$ префикс $Log_{C_j}$, либо $Log_{C_j}$ префикс $Log_{C_i}$. Считаем, что $x$ префиксом самого себя и $\emptyset$ префиксом $x$.

Будем считать, что честный участник удовлетворяет свойству \textit{самоконсистентности}, если выполняется: пусть участник честный во время $t$ и $t' \ge t$, $Log_{C_i}$~--- лог в момент времени $t$, $Log'_{C_i}$~--- в момент времени $t'$, тогда верно, что $Log_{C_i}$ префикс $Log'_{C_i}$.

Будем называть алгоритм \textit{консистентным}, если для него выполняется свойство общего префикса и для любого участника выполняется свойство самоконсистентности.
 
Далее будет приведено доказательство консистентности предложенного алгоритма.

\textbf{\textit{Лемма 0.}} Про устойчивое состояние.

\textbf{\textit{Лемма 1.}} \textit{В любой момент времени, для любого слота $s$ существует не более одного оседлого значения $d$.}

Прежде всего, заметим, что весь жизненный цикл системы разбивается на последовательность времен
$t_0 \le t_1 \le t_2 \le t_3 \le ...$, $t_0=0$, где в полуитервалы времени $[t_{2k}...t_{2k+1})$ система находится в устойчивом состоянии, а в полуинтервалы $[t_{2k+1}...t_{2k+2})$ в неустойчивом.

Докажем утверждение для момента времени в рамках одного устойчивого состояния.
Зафиксируем некоторый слот $s$. Предположим, что существуют два оседлых значения $d_1$ и $d_2$ в слоте $s$. Рассмотрим сертификат согласия $\mathcal{P}_1$ любого участника для $d_1$ и сертификат согласия $\mathcal{P}_2$ любого участника для $d_2$. Среди $2f+1$ $Prepare$ сообщений $\mathcal{P}_1$ имеется не более $f$ нечестных участников, аналогично для $\mathcal{P}_2$. Отсюда следует, что найдется как минимум один честный участник, который есть как среди $Prepare$ сообщений из $\mathcal{P}_1$, так и среди $\mathcal{P}_2$. Это значит, что для слота $s$ он получил два $Propose$ сообщения с разными $d$, однако, если он ответил на одно из них $Prepare$ сообщением, значит он не мог бы сделать это для второго, так как это противоречит проверкам 1.1 из раздела \ref{steady-state}.

Теперь рассмотрим момент времени в рамках неустойчивого состояния. 
Если для пред уст сост существовало оседлое $d$, то невозможно добиться другого оседлого.

Если не существовало, необходимо доказать, что при любом исполнении в след стэди стейт суещствовать его не будет.

TODO $\square$

\textbf{\textit{Лемма 2.}} Если в некоторый момент времени для слота $s$ существует некоторое оседлое значение $d$, то данное изменение в будущем неизбежно окажется в логе применения всех честных участников в слоте $s$.

TODO $\square$

\vspace{10pt}

\textit{Следствие из Леммы 1.} Если хотя бы один честный участник имеет сертификат применения $\mathcal{C}$ для изменения $d$ соответствующему слоту $s$, то  изменение $d$ неизбежно окажется в логе применения всех честных участников в слоте $s$. 

Так как, из того что участник имеет $\mathcal{C}$, следует что как минимум $f+1$ честный участник отправил $Commit$ сообщение, имея сертификат согласия для $d$ и $s$. $\square$
\vspace{10pt}

\textbf{Теорема.} \textit{В любой момент времени логи честных участников консистентны.}

Предположим, что в некоторый момент времени существуют различные участники $i$ и $j$, такие что, существует $s$, для которого выполняется, что изменение из $Log_{C_i}[s]$ неравно изменению из $Log_{C_j}[s]$.

Данное предположение противоречит Следствию из Леммы 1, так сертификат согласия для одного из сертификатов применения были у $f+1$ участника раньше, чем для другого.

Свойство самоконсистентности очевидно, так как в описанном алгоритме изменения не удаляются из лога применений и не модифицируются, а только добавляются в него. $\square$

\section{Живучесть алгоритма}
\noindent Следующее свойство ~--- \textit{живучесть} (Liveness) \cite{hybrid-consensus}:
пусть честный участник получил транзакцию во время $t$, тогда данная транзакция будет добавлена в хранилище всеми \textit{честными} участниками не позднее $t + T_{confirm}$.

Данное свойство использует параметр $T_{confirm}$, предполагается что данный параметр постоянен на протяжении всего времени и известен зараннее.


\section{Отзывчивость алгоритма}